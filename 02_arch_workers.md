# MISSION 02: HIGH-LOAD ARCHITECTURE (REDIS + BULLMQ)

## üéØ –¶–ï–õ–¨
–í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—á–µ—Ä–µ–¥–µ–π (Message Queue) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—è–∂–µ–ª—ã—Ö –∑–∞–¥–∞—á (AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –ø–∞—Ä—Å–∏–Ω–≥, API –∑–∞–ø—Ä–æ—Å—ã).
–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ Next.js (Frontend/API) –¥–æ–ª–∂–µ–Ω —Ç–æ–ª—å–∫–æ **–ø—Ä–∏–Ω–∏–º–∞—Ç—å** –∑–∞–¥–∞—á—É –∏ –æ—Ç–¥–∞–≤–∞—Ç—å ID. –í—ã–ø–æ–ª–Ω—è—Ç—å –µ—ë –¥–æ–ª–∂–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π **Worker**.

## üõ† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö
- **BullMQ:** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π (–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è Node.js).
- **Redis:** –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ (–Ω—É–∂–µ–Ω –∏–Ω—Å—Ç–∞–Ω—Å Redis, –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –≤ –æ–±–ª–∞–∫–µ).
- **Separation of Concerns:** –ü—Ä–æ–¥—é—Å–µ—Ä—ã (API) –∏ –ö–æ–Ω—Å—å—é–º–µ—Ä—ã (Workers) —Ä–∞–∑–¥–µ–ª–µ–Ω—ã.

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô (STEP-BY-STEP)

### –≠–¢–ê–ü 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Setup)
1. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `npm install bullmq ioredis`.
2. –ù–∞—Å—Ç—Ä–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis:
   - –°–æ–∑–¥–∞–π `lib/redis.ts` (Singletone –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –∫–æ–Ω–Ω–µ–∫—Ç—ã).
   - –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `REDIS_URL`.
   - –ï—Å–ª–∏ –Ω–µ—Ç Redis –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ `docs/REDIS_SETUP.md` (–∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å —á–µ—Ä–µ–∑ Docker).

### –≠–¢–ê–ü 2: –û—á–µ—Ä–µ–¥—å (The Queue)
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `lib/queue/index.ts`.
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π –æ—á–µ—Ä–µ–¥—å —Å –∏–º–µ–Ω–µ–º `expert-os-tasks`.
3. –†–µ–∞–ª–∏–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é-—Ö–µ–ª–ø–µ—Ä `addJobToQueue(type, data)`, –∫–æ—Ç–æ—Ä–∞—è —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–π Zod –∏–ª–∏ TS Interfaces).

### –≠–¢–ê–ü 3: –í–æ—Ä–∫–µ—Ä (The Worker)
1. –°–æ–∑–¥–∞–π –ø–∞–ø–∫—É `workers/`.
2. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `workers/main.worker.ts`.
3. –í–æ—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω:
   - –°–ª—É—à–∞—Ç—å –æ—á–µ—Ä–µ–¥—å `expert-os-tasks`.
   - –ò–º–µ—Ç—å `Switch/Case` –∏–ª–∏ `Map` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, `PROCESS_DOCUMENT`, `GENERATE_CONTENT`).
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (try/catch) –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –¥–∂–æ–±—ã (Completed/Failed).
   - **–í–ê–ñ–ù–û:** –í–æ—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º (–Ω–µ –≤–Ω—É—Ç—Ä–∏ Next.js build). –î–æ–±–∞–≤—å —Å–∫—Ä–∏–ø—Ç –≤ `package.json`: `"worker": "ts-node workers/main.worker.ts"` (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ).

### –≠–¢–ê–ü 4: Proof of Concept (–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω)
1. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π Server Action `actions/test-queue.ts`.
2. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –æ–Ω –¥–æ–ª–∂–µ–Ω –∫–ª–∞—Å—Ç—å –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å.
3. –í–æ—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –µ—ë –∏ –ø–∏—Å–∞—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—å "Processing job... Done".

## üõ° –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–û–î–£ (SOLIS)
- **Error Handling:** –ï—Å–ª–∏ Redis –æ—Ç–≤–∞–ª–∏–ª—Å—è, —Å–∞–π—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å (Graceful degradation).
- **Error Handling:** –ï—Å–ª–∏ Redis –æ—Ç–≤–∞–ª–∏–ª—Å—è, —Å–∞–π—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–∞–¥–∞—Ç—å (Graceful degradation).
- **Typing:** –ù–∏–∫–∞–∫–∏—Ö `job.data` –±–µ–∑ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏. –û–ø–∏—à–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `JobData`.

## üö¶ DEFINITION OF DONE
1. –ö–æ–º–∞–Ω–¥–∞ `npm run worker` –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏ –æ–Ω —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç—Å—è –∫ Redis.
2. –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—É—Ç—å: API -> Redis -> Worker -> Console Log.
3. –ö–æ–¥ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ `lib/queue` –∏ `workers`, –Ω–µ —Ä–∞–∑–º–∞–∑–∞–Ω –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º.