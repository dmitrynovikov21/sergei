# MISSION 03: TOKENOMICS & FIN-OPS (LITELLM)

## üéØ –¶–ï–õ–¨
–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É "–î–≤–æ–π–Ω–æ–π –∑–∞–ø–∏—Å–∏" –¥–ª—è —É—á–µ—Ç–∞ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ò–ò.
–ú—ã –¥–æ–ª–∂–Ω—ã –∑–Ω–∞—Ç—å:
1. –°–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ (Cost).
2. –°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–æ —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Revenue).
3. –ö–∞–∫–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è.

## üõ† –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
- **LiteLLM:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫—É (–∏–ª–∏ —á–µ—Ä–µ–∑ HTTP Proxy, –µ—Å–ª–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç) –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI/Anthropic/DeepSeek.
- **Prisma:** –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –≠–¢–ê–ü 1: Schema Update (Prisma)
1. –î–æ–±–∞–≤—å –≤ `prisma/schema.prisma` –º–æ–¥–µ–ª—å `Transaction` (–∏–ª–∏ `UsageLog`).
   –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –ø–æ–ª—è:
   - `id`: uuid
   - `userId`: relation to User
   - `provider`: string (e.g., "openai", "anthropic")
   - `model`: string (e.g., "gpt-4o")
   - `inputTokens`: int
   - `outputTokens`: int
   - `totalCost`: float (–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ $)
   - `userCharge`: float (–°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–ª–∏ —Å —é–∑–µ—Ä–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤–∞–ª—é—Ç—ã)
   - `context`: json (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ID –¥–æ–∫—É–º–µ–Ω—Ç–∞, —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏)
   - `createdAt`: datetime
2. –°–¥–µ–ª–∞–π –º–∏–≥—Ä–∞—Ü–∏—é.

### –≠–¢–ê–ü 2: Service Layer (AI Gateway)
1. –°–æ–∑–¥–∞–π —Å–µ—Ä–≤–∏—Å `services/ai-gateway.ts`.
2. –†–µ–∞–ª–∏–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é `generateCompletion(messages, model, userId)`.
3. –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π LiteLLM.
4. **–ì–õ–ê–í–ù–û–ï:** –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –û–ë–Ø–ó–ê–ù–ê —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î (–≤ –º–æ–¥–µ–ª—å `Transaction`).
   - –¢—ã –¥–æ–ª–∂–µ–Ω –≤—ã—Ç–∞—â–∏—Ç—å `usage` –∏–∑ –æ—Ç–≤–µ—Ç–∞ LiteLLM.
   - –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ —Ö–∞—Ä–¥–∫–æ–¥–æ–º –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥ LiteLLM).

### –≠–¢–ê–ü 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –í–æ—Ä–∫–µ—Ä–æ–º
1. –í–µ—Ä–Ω–∏—Å—å –≤ `workers/main.worker.ts`.
2. –ó–∞–º–µ–Ω–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ `console.log` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ `ai-gateway.ts`.
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–≥–¥–∞ –≤–æ—Ä–∫–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É, –≤ –±–∞–∑–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö.

## üß† –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê (SOLIS Check)
- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏ –∑–∞–ø–∏—Å—å –ª–æ–≥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–º–∏. –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤ –ë–î –Ω–µ –ø—Ä–æ—à–ª–∞, –º—ã –¥–æ–ª–∂–Ω—ã –∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º (–ª–æ–≥–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É `CRITICAL_BILLING_ERROR`).
- **–ò–∑–æ–ª—è—Ü–∏—è:** –°–µ—Ä–≤–∏—Å AI Gateway –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –ø—Ä–æ UI. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç + –ø–∏—à–µ—Ç –ª–æ–≥.

## üö¶ DEFINITION OF DONE
1. –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
2. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ `inputTokens` / `outputTokens`.
3. –ü–æ–ª–µ `userId` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç—Å—è –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –∑–∞–¥–∞—á–∏ –¥–æ –∑–∞–ø–∏—Å–∏ –≤ –ë–î.