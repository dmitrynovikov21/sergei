name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no root@$SERVER_HOST << 'DEPLOY_SCRIPT'
          cd /root/sergei
          
          echo ">>> Backup DB"
          cp prisma/dev.db "prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)" || echo "backup skipped"
          
          echo ">>> Git pull"
          git fetch origin production 2>&1
          git reset --hard origin/production 2>&1
          
          echo ">>> npm install"
          npm install --production=false 2>&1 || echo "npm warnings"
          
          echo ">>> Prisma generate"
          npx prisma generate 2>&1 || echo "prisma warnings"
          
          echo ">>> Build"
          npm run build 2>&1
          
          echo ">>> Restart server"
          pkill -f "next-server" 2>&1 || echo "no running server"
          sleep 2
          cd /root/sergei
          NODE_OPTIONS="--dns-result-order=ipv4first" nohup npx next start > /tmp/nextjs.log 2>&1 &
          sleep 5
          
          echo ">>> Health check"
          curl -s -o /dev/null -w "HTTP %{http_code}" http://localhost:3000 || echo "health check failed"
          echo ""
          echo ">>> Deploy complete"
          DEPLOY_SCRIPT
