name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          command_timeout: 10m
          script: |
            cd /root/sergei
            
            # 1. Backup database before any changes
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp prisma/dev.db "prisma/dev.db.backup.$TIMESTAMP"
            echo "DB backed up"
            
            # 2. Pull latest code (DB is in .gitignore, safe)
            git fetch origin production
            git reset --hard origin/production
            echo "Code updated"
            
            # 3. Install dependencies
            npm install --production=false
            echo "Dependencies installed"
            
            # 4. Apply schema changes safely (no data loss)
            npx prisma generate
            npx prisma db push
            echo "Prisma schema applied"
            
            # 5. Build Next.js
            npm run build
            echo "Build complete"
            
            # 6. Restart Next.js (find and kill, then start)
            pkill -f "next-server" || true
            sleep 2
            cd /root/sergei && NODE_OPTIONS="--dns-result-order=ipv4first" nohup npx next start > /tmp/nextjs.log 2>&1 &
            sleep 3
            
            # 7. Verify
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
            echo "Health check: $HTTP_CODE"
            if [ "$HTTP_CODE" != "200" ]; then
              echo "DEPLOY FAILED - server not responding"
              exit 1
            fi
            echo "Deployment complete!"
