name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          command_timeout: 10m
          script: |
            set -e
            cd /root/sergei
            
            echo "=== Step 1: Backup DB ==="
            cp prisma/dev.db "prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)" || true
            
            echo "=== Step 2: Pull code ==="
            git fetch origin production
            git reset --hard origin/production
            
            echo "=== Step 3: Install deps ==="
            npm install --production=false 2>&1
            
            echo "=== Step 4: Prisma ==="
            npx prisma generate 2>&1
            npx prisma db push --accept-data-loss 2>&1 || true
            
            echo "=== Step 5: Build ==="
            npm run build 2>&1
            
            echo "=== Step 6: Restart ==="
            pkill -f "next-server" || true
            sleep 2
            
            echo "=== Step 7: Start server ==="
            cd /root/sergei
            NODE_OPTIONS="--dns-result-order=ipv4first" nohup npx next start > /tmp/nextjs.log 2>&1 &
            sleep 5
            
            echo "=== Step 8: Health check ==="
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            echo "HTTP status: $HTTP_CODE"
            
            echo "Deploy finished"
