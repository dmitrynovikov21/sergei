name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          command_timeout: 10m
          script: |
            cd /root/sergei
            
            echo ">>> Backup DB"
            cp prisma/dev.db "prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)" || echo "backup skipped"
            
            echo ">>> Git pull"
            git fetch origin production 2>&1
            git reset --hard origin/production 2>&1
            
            echo ">>> npm install"
            npm install --production=false 2>&1 || echo "npm install had warnings"
            
            echo ">>> Prisma generate"
            npx prisma generate 2>&1 || echo "prisma generate failed"
            
            echo ">>> Build"
            npm run build 2>&1
            
            echo ">>> Restart server"
            pkill -f "next-server" 2>&1 || echo "no running server"
            sleep 2
            cd /root/sergei
            NODE_OPTIONS="--dns-result-order=ipv4first" nohup npx next start > /tmp/nextjs.log 2>&1 &
            sleep 5
            
            echo ">>> Health check"
            curl -s -o /dev/null -w "HTTP %{http_code}" http://localhost:3000 || echo "health check failed"
            echo ""
            echo ">>> Deploy done"
