generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model User {
  id                     String    @id @default(cuid())
  name                   String?
  email                  String?   @unique
  emailVerified          DateTime?
  password               String?
  image                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @default(now()) @map("updated_at")
  role                   String    @default("USER")
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")
  credits                Int       @default(0)
  referralCode           String?   @unique @map("referral_code")
  referrerId             String?   @map("referrer_id")
  referralBalance        Float     @default(0.0) @map("referral_balance")
  
  accounts               Account[]
  agents                 Agent[]
  chats                  Chat[]
  datasets               Dataset[]
  projects               Project[]
  sessions               Session[]
  transactions           TokenTransaction[]
  creditTransactions     CreditTransaction[]
  
  // Relations for referral system
  referredBy             User?     @relation("Referrals", fields: [referrerId], references: [id])
  referrals              User[]    @relation("Referrals")
  referralTransactions   ReferralTransaction[]
  payoutRequests         PayoutRequest[]

  @@map("users")
}

model ReferralTransaction {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  amount       Float
  type         String   // ACCRUAL, WITHDRAWAL
  status       String   @default("COMPLETED") // COMPLETED, PENDING, REJECTED
  sourceUserId String?  @map("source_user_id") // Who made the payment (for accruals)
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("referral_transactions")
}

model PayoutRequest {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  amount    Float
  status    String   @default("PENDING") // PENDING, PAID, REJECTED
  details   String?  // Card number, etc.
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payout_requests")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model Agent {
  id               String      @id @default(cuid())
  userId           String?
  name             String
  description      String?
  systemPrompt     String
  emoji            String?
  isPublic         Boolean     @default(false)
  model            String      @default("claude-4-5-sonnet")
  useEmoji         Boolean     @default(false)
  useSubscribe     Boolean     @default(false)
  useLinkInBio     Boolean     @default(false)
  codeWord         String?
  audienceQuestion String?
  subscribeLink    String?
  userContext      String?
  datasetId        String?
  dataset          Dataset?    @relation(fields: [datasetId], references: [id])
  isFavorite       Boolean     @default(false)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @default(now()) @updatedAt @map("updated_at")
  files            AgentFile[]
  user             User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  chats            Chat[]

  @@index([userId])
  @@index([datasetId])
  @@map("agents")
}

model AgentFile {
  id        String   @id @default(cuid())
  agentId   String
  name      String
  content   String
  type      String?
  createdAt DateTime @default(now()) @map("created_at")
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@map("agent_files")
}

model Project {
  id        String   @id @default(cuid())
  userId    String
  name      String
  icon      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  chats     Chat[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("projects")
}

model Chat {
  id        String    @id @default(cuid())
  agentId   String
  userId    String
  projectId String?
  datasetId String?
  title     String?   @default("New Chat")
  icon      String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  dataset   Dataset?  @relation(fields: [datasetId], references: [id])
  project   Project?  @relation(fields: [projectId], references: [id])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([agentId])
  @@index([projectId])
  @@index([datasetId])
  @@map("chats")
}

model Message {
  id               String       @id @default(cuid())
  chatId           String
  role             String
  content          String
  promptTokens     Int          @default(0)
  completionTokens Int          @default(0)
  cost             Float        @default(0.0)
  createdAt        DateTime     @default(now()) @map("created_at")
  attachments      Attachment[]
  chat             Chat         @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@map("messages")
}

model Attachment {
  id        String   @id @default(cuid())
  url       String
  name      String?
  type      String?
  messageId String
  createdAt DateTime @default(now()) @map("created_at")
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("attachments")
}

model Dataset {
  id          String           @id @default(cuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean          @default(false)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @default(now()) @updatedAt @map("updated_at")
  chats       Chat[]
  agents      Agent[]
  items       ContentItem[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sources     TrackingSource[]

  @@index([userId])
  @@map("datasets")
}

model TrackingSource {
  id             String         @id @default(cuid())
  url            String
  username       String?
  datasetId      String
  isActive       Boolean        @default(true)
  minViewsFilter Int            @default(0)
  fetchLimit     Int            @default(500)
  lastScrapedAt  DateTime?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at")
  daysLimit      Int            @default(30)
  contentTypes   String         @default("Video,Sidecar,Image")
  dataset        Dataset        @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  parseHistory   ParseHistory[]

  @@index([datasetId])
  @@map("tracking_sources")
}

model ParseHistory {
  id           String          @id @default(cuid())
  sourceId     String
  source       TrackingSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  startedAt    DateTime        @default(now()) @map("started_at")
  completedAt  DateTime?       @map("completed_at")
  status       String          @default("running") // "running", "completed", "failed"
  daysRange    Int             @default(7) // 7 or 14
  postsFound   Int             @default(0) @map("posts_found")
  postsAdded   Int             @default(0) @map("posts_added")
  postsSkipped Int             @default(0) @map("posts_skipped")
  error        String?

  @@index([sourceId])
  @@index([startedAt])
  @@map("parse_history")
}

model ContentItem {
  id              String    @id @default(cuid())
  instagramId     String
  originalUrl     String
  sourceUrl       String?
  coverUrl        String?
  videoUrl        String?
  views           Int       @default(0)
  likes           Int       @default(0)
  comments        Int       @default(0)
  publishedAt     DateTime?
  headline        String?
  transcript      String?
  isProcessed     Boolean   @default(false)
  isApproved      Boolean   @default(false)
  processingError String?
  viralityScore   Float?    // Ratio of views to batch average (e.g. 1.5 = 50% above average)
  datasetId       String
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")
  dataset         Dataset   @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([instagramId, datasetId])
  @@index([datasetId])
  @@index([isApproved])
  @@map("content_items")
}

model TokenTransaction {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  model        String
  inputTokens  Int
  outputTokens Int
  totalCost    Float
  context      String? // We keep it as String for SQLite compatibility (store JSON stringified)
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("token_transactions")
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int      // Negative for spending, Positive for top-up
  reason      String   // e.g. "ai-completion", "top-up", "bonus"
  metadata    String?  // JSON string for extra details (e.g. related TokenTransactionId)
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_transactions")
}
