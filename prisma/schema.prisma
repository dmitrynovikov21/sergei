generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model agent_files {
  id         String   @id
  agentId    String
  name       String
  content    String
  type       String?
  createdAt  DateTime @default(now()) @map("created_at")
  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

model Agent {
  id               String        @id
  userId           String?
  name             String
  description      String?
  systemPrompt     String
  emoji            String?
  isPublic         Boolean       @default(false)
  model            String        @default("claude-4-5-sonnet")
  useEmoji         Boolean       @default(false)
  useSubscribe     Boolean       @default(false)
  useLinkInBio     Boolean       @default(false)
  codeWord         String?
  audienceQuestion String?
  subscribeLink    String?
  userContext      String?
  datasetId        String?
  isFavorite       Boolean       @default(false)
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @default(now()) @map("updated_at")
  user             User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataset          Dataset?      @relation(fields: [datasetId], references: [id])
  chats            Chat[]
  files            agent_files[]

  @@index([datasetId])
  @@index([userId])
  @@map("agents")
}

model attachments {
  id         String   @id
  url        String
  name       String?
  type       String?
  messageId  String
  created_at DateTime @default(now())
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}


model Chat {
  id         String     @id
  agentId    String
  userId     String
  projectId  String?
  datasetId  String?
  title      String?    @default("New Chat")
  icon       String?
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @default(now()) @map("updated_at")
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project    Project?   @relation(fields: [projectId], references: [id])
  dataset    Dataset?   @relation(fields: [datasetId], references: [id])
  messages   Message[]
  agent      Agent      @relation(fields: [agentId], references: [id])

  @@index([datasetId])
  @@index([projectId])
  @@index([agentId])
  @@index([userId])
  @@map("chats")
}

model ContentItem {
  id              String    @id
  instagramId     String
  originalUrl     String
  sourceUrl       String?
  coverUrl        String?
  videoUrl        String?
  views           Int       @default(0)
  likes           Int       @default(0)
  comments        Int       @default(0)
  publishedAt     DateTime?
  headline        String?
  transcript      String?
  isProcessed     Boolean   @default(false)
  isApproved      Boolean   @default(false)
  processingError String?
  viralityScore   Float?
  datasetId       String
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @map("updated_at")
  description     String?
  // NEW: Archiving
  isArchived      Boolean   @default(false)
  archivedAt      DateTime?
  // NEW: Content categorization
  topicCategory   String?
  contentType     String?   // "Video", "Sidecar", "Image"
  dataset         Dataset   @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([instagramId, datasetId])
  @@index([isApproved])
  @@index([datasetId])
  @@index([isArchived])
  @@map("content_items")
}

model CreditTransaction {
  id        String   @id
  userId    String   @map("user_id")
  amount    Int
  reason    String
  metadata  String?
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_transactions")
}

model Dataset {
  id               String             @id
  name             String
  description      String?
  userId           String
  isPublic         Boolean            @default(false)
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @default(now()) @map("updated_at")
  agents           Agent[]
  chats            Chat[]
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  sources          TrackingSource[]
  items            ContentItem[]

  @@index([userId])
  @@map("datasets")
}

model Message {
  id               String        @id
  chatId           String
  role             String
  content          String
  promptTokens     Int           @default(0)
  completionTokens Int           @default(0)
  cost             Float         @default(0.0)
  createdAt        DateTime      @default(now()) @map("created_at")
  attachments      attachments[]
  chat             Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@map("messages")
}

model parse_history {
  id               String           @id
  sourceId         String
  started_at       DateTime         @default(now())
  completed_at     DateTime?
  status           String           @default("running")
  daysRange        Int              @default(14)  // Hardcoded 14 days
  posts_found      Int              @default(0)
  posts_added      Int              @default(0)
  posts_skipped    Int              @default(0)
  posts_filtered   Int              @default(0)   // NEW: filtered by threshold
  posts_archived   Int              @default(0)   // NEW: moved to archive
  posts_updated    Int              @default(0)   // NEW: stats updated
  apify_raw_count  Int              @default(0)   // NEW: raw Apify count
  error            String?
  source           TrackingSource   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([started_at])
  @@index([sourceId])
}

model password_reset_tokens {
  id      String   @id
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model payout_requests {
  id         String   @id
  user_id    String
  amount     Float
  status     String   @default("PENDING")
  details    String?
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model Project {
  id         String   @id
  userId     String
  name       String
  icon       String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @map("updated_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chats      Chat[]

  @@index([userId])
  @@map("projects")
}

model referral_transactions {
  id             String  @id
  user_id        String
  amount         Float
  type           String
  status         String  @default("COMPLETED")
  source_user_id String?
  user           User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model TokenTransaction {
  id           String   @id
  userId       String
  provider     String
  model        String
  inputTokens  Int
  outputTokens Int
  totalCost    Float
  context      String?
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("token_transactions")
}

model TrackingSource {
  id             String         @id
  url            String
  username       String?
  datasetId      String
  isActive       Boolean        @default(true)
  minViewsFilter Int            @default(0)   // For Reels (Video)
  minLikesFilter Int            @default(0)   // For Carousels (Sidecar/Image)
  fetchLimit     Int            @default(500)
  lastScrapedAt  DateTime?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @map("updated_at")
  // daysLimit removed - hardcoded to 14 days
  contentTypes   String         @default("Video,Sidecar,Image")
  parseFrequency String         @default("weekly") // "daily", "3days", "weekly"
  parseHistory   parse_history[]
  dataset        Dataset        @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
  @@map("tracking_sources")
}

model User {
  id                        String                  @id
  name                      String?
  email                     String?                 @unique
  emailVerified             DateTime?
  password                  String?
  image                     String?
  createdAt                 DateTime                @default(now()) @map("created_at")
  updatedAt                 DateTime                @default(now()) @map("updated_at")
  role                      String                  @default("USER")
  stripeCustomerId          String?                 @unique @map("stripe_customer_id")
  stripeSubscriptionId      String?                 @unique @map("stripe_subscription_id")
  stripePriceId             String?                 @map("stripe_price_id")
  stripeCurrentPeriodEnd    DateTime?               @map("stripe_current_period_end")
  credits                   Int                     @default(0)
  referralCode              String?                 @unique @map("referral_code")
  referrerId                String?                 @map("referrer_id")
  referralBalance           Float                   @default(0.0) @map("referral_balance")
  accounts                  Account[]
  agents                    Agent[]
  chats                     Chat[]
  creditTransactions       CreditTransaction[]
  datasets                  Dataset[]
  payout_requests           payout_requests[]
  projects                  Project[]
  referral_transactions     referral_transactions[]
  sessions                  Session[]
  subscriptions             Subscription[]
  tokenTransactions        TokenTransaction[]
  referrer                  User?                   @relation("UserToUser", fields: [referrerId], references: [id])
  referrals                 User[]                  @relation("UserToUser")

  @@map("users")
}

model Subscription {
  id            String    @id @default(uuid())
  userId        String
  plan          String    // "reels" | "carousels"
  credits       Int       // Remaining credits this period
  maxCredits    Int       // Plan limit (12500 or 6250)
  priceRub      Int       // Price paid (2000 or 1000)
  startsAt      DateTime  @default(now())
  expiresAt     DateTime  // +1 month from startsAt
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("subscriptions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model SystemSettings {
  id        String   @id @default("default")
  key       String   @unique
  value     String
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

